## Solution description

### Energy meter

Utility meter installed by PGE is GAMA 350 series.

![photo of GAMA 350 utility meter with led indicators and DLMS port marked](https://raw.githubusercontent.com/malipek/esp8266_utility_meter_mon/master/assets/GAMA350_utility_meter.jpg)

Following important parts are marked:

1. Infrared optical port, DLMS protocol (disabled).
2. Active power consumption LED indicator (1000 pulses for 1 kilo-Watt hour).
3. Reactive power consumption LED indicator (1000 pulses for 1 kilo-Var hour).

### The sensor

The sensor is based on the light detection resistor (LDR) mounted to monitor active power LED indicator.

![photo of GAMA 350 utility meter LDR mounted opposite to active power LED indicator](https://raw.githubusercontent.com/malipek/esp8266_utility_meter_mon/master/assets/LDR_mounted.jpg)

#### MOSFET approach

First approach to sensor is based on 2N7000 N-MOSFET.

![schematics of sensor based on 2N7000](https://raw.githubusercontent.com/malipek/esp8266_utility_meter_mon/master/assets/2N7000_pulse_detector.png)

LDR with the resistance around 100kΩ in the dark in pair with potentiometer RP1 work as a voltage divider. The gate potential is around the ground, and the MOSFET is cut-off. Resistor R1 works as pull-up. Potential on DOut is VCC. 

When resistance on LDR drops to less than hundreds of Ohms (utility meter LED indicator is on), almost all VCC voltage drops across PR1. The gate has near-VCC potential, and the MOSFET is saturated. The current flows through R1 resistor, so voltage on VOut is down to ground. The pulse is sent to the microcontroler.

Pros:
+ low power consumption: max around 0.1mW,
+ compact circuit,
+ very cheap components: around $1.3.

Cons:
- very difficult sensitivity regulation, in practice neighboring LED was causing false pulses,
- [dirty hack in interrupt handler routine had to be implemented due to wide pulse](https://github.com/malipek/esp8266_utility_meter_mon/blob/master/SOLUTION.md#dirty-hack-on-digital-pin-interrupt).

#### Comparator approach

Next solution was based on LM393 comparator.

![schematics of sensor based on LM393 comparator](https://raw.githubusercontent.com/malipek/esp8266_utility_meter_mon/master/assets/LM393P_pulse_detector.png)

The comparator's output (Open Collector) is pulled up to VCC via resistor R1 if the voltage drop across the LDR is greater then the one set on PR1 divider (in dark).

During the utility meter LED's pulse, the voltage's drop across LDR goes to zero, and the comparator's output is shorted to ground. Logic-low pulse is generated on DOut.

Pros:

+ high resolution of sensitivity regulation,
+ can be set to ignore pulses from neighboring LED indicator,
+ still very cheap: around $1.7.

Cons:
- higher power consumption: around 0.33mW,
- [dirty hack in interrupt handler routine had to be implemented due to wide pulse](https://github.com/malipek/esp8266_utility_meter_mon/blob/master/SOLUTION.md#dirty-hack-on-digital-pin-interrupt).

#### Dirty hack on digital pin interrupt

Pulse generated by sensor in both approaches is mirroring utility meter LED pulse length. It is [too wide for ESP-family hardware interrupt processing logic (30ms)](https://github.com/espressif/arduino-esp32/issues/4172).

![Screenshot of the scope view with measurement on sensor's pulse](https://raw.githubusercontent.com/malipek/esp8266_utility_meter_mon/master/assets/LM393P_pulse_measurement.png)

Single pulse was triggering multiple interrupts, due to transient states, [and long-lasting low state](https://github.com/espressif/arduino-esp32/issues/4172).

As a workaround, the dirty hack was added, so the pulse is counted only when:
* logical low state is present on pulse input, and
* after delay of 10ms in the interrupt routine.

```
delay(10);
if (digitalRead(pulse_sensor)==LOW){
    counter++;
}
```

#### Comparator with integrator and inverter

Final solution combined LM393 comparator, RC integrator and inverter based on 2N7000 N-channel MOSFET.

![schematics of sensor based on LM393 comparator, RC integrator and 2N7000 based inverter](https://raw.githubusercontent.com/malipek/esp8266_utility_meter_mon/master/assets/LM393_integrator_inverter_detector.png)

The sensor is build of 3 main sections:

![schematics of sensor based on LM393 comparator, RC integrator and 2N7000-based inverter, divided into sections](https://raw.githubusercontent.com/malipek/esp8266_utility_meter_mon/master/assets/LM393_integrator_inverter_detector_sections.png)

1. LM393P-based comparator, connected to LDR sensor, with PR1 potentiometer for setting up the trigger level.
2. RC integrator.
3. 2N7000 N-channel MOSFET-based inverter
 
Resistor R3 limits the current flowing across the LDR when LED from utility meter is turned-on.

Potentiometer PR1 sets the reference voltage which causes the comparator to generate pulse.

The value of the PR1 should be approximately 2 times R3.

LM393 has open-collector output/ground output, so R1 pull-up is needed.

For manual on setting PR1 adjustment for your utility-meter, check the [Sensor adjusting](https://github.com/malipek/esp8266_utility_meter_mon/blob/master/SOLUTION.md#sensor-adjusting) section.

Next stage is RC integrator. Here, spikes are generated, according to how fast input signal is changing. 

C1 and R4 values are paired in a way, that the current flow across them is as low as possible, and the spike on falling input is not longer then 250µs.

You may use scope in the configuration as below to check if C1 and R4 values are selected correctly.

![schematics of sensor based on LM393 comparator, integrator and inverter with scope connection points at the output of the RC integrator](https://raw.githubusercontent.com/malipek/esp8266_utility_meter_mon/master/assets/LM393_integrator_scope.png)

![Screenshot of the scope view with pulse at the RC integrator output](https://raw.githubusercontent.com/malipek/esp8266_utility_meter_mon/master/assets/RC_integrator_output.png)

Output from RC integrator is passed directly to the gate of 2N7000 N-MOSFET. Normally, GS's voltage is around VCC, and the MOSFET is saturated. Small current flows across the R5 and the DOut is shorted to the ground. Positive spikes of input signal above the VCC (on comparator's rising edge) don't change that state.

During spikes to the ground on input (comparator's falling edge), the MOSFET goes to cut-off state, and DOut is pulled up to VCC level, as it's shown on the scope.

![schematics of sensor based on LM393 comparator, integrator and inverter with scope connection points at DOut integrator](https://raw.githubusercontent.com/malipek/esp8266_utility_meter_mon/master/assets/LM393_integrator_inverter_scope.png)

![Screenshot of the scope view with pulse at DOutm, measured pulse width](https://raw.githubusercontent.com/malipek/esp8266_utility_meter_mon/master/assets/inverter_output_pulse_length.png)

Pros:

+ high resolution of sensitivity regulation,
+ can be set to ignore pulses from neighboring LED indicator,
+ still very cheap: around $2.20,
+ works well with hardware interrupt on ESP8266, no dirty hacks needed. 

Cons:
- power consumption: around 0.33mW.


### Sensor adjusting

Sensor must be adjusted individually to utility meter (LED intensivity, pulse length), so its reading is not interfered with light in the room, or neighboring indicators.

The voltage drop must detect fast changing signal, so no transient states are present on comparator's output.

Using oscilloscope is a must have. Check probe points on schematics below:

![schematics of sensor based on LM393 comparator with scope connection points](https://raw.githubusercontent.com/malipek/esp8266_utility_meter_mon/master/assets/LM393_integrator_inverter_detector_scope_measurements.png)

![Screenshot of the scope view with pulse at the comparator output](https://raw.githubusercontent.com/malipek/esp8266_utility_meter_mon/master/assets/comparator_output_pulse.png)

Regulation must be done using potentiometer PR1, to achieve the following:

1. neighboring LED pulse does not trigger pulse,
![Screenshot of the scope view with neighboring indicator LED on not triggering sensor's pulse](https://raw.githubusercontent.com/malipek/esp8266_utility_meter_mon/master/assets/passive_power_pulse.png)

2. pulse is triggered on the fast falling signal,
![Screenshot of the scope view with slow-changing LDR voltage marked](https://raw.githubusercontent.com/malipek/esp8266_utility_meter_mon/master/assets/LDR_voltage_area_to_low.png)


3. pulse is triggered on as low voltage drop on LDR as possible.
![Screenshot of the scope view with markers on LDR voltage drop that triggers sensor's pulse](https://raw.githubusercontent.com/malipek/esp8266_utility_meter_mon/master/assets/LDR_voltage_treshold.png)

### NodeMCUv3 connection

The circuit requires stabilized 3.3V power supply to work properly. Connect it to VCC pins on both circuits. DOut is connected to the D6 pin on NodeMCUv3. GND is common ground, connected to negative connection on power supply.

![Schematics of pinout of NodeMCUv3 with sensor's connection points marked.](https://raw.githubusercontent.com/malipek/esp8266_utility_meter_mon/master/assets/NodeMCUv3_connection.png)

To make the solution working upload [the code](https://github.com/malipek/esp8266_utility_meter_mon/blob/master/esp8266_utility_meter_mon.ino).